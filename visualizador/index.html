<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visualizador C a x86</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #1e1e1e; color: #d4d4d4; font-family: monospace; }
        textarea { background: #252526; color: #9cdcfe; border: 1px solid #444; width: 100%; height: 300px; padding: 10px; resize: none; }
        .box { background: #000; border: 1px solid #333; padding: 10px; height: 300px; overflow-y: auto; font-size: 0.9em; }
        .reg-val { 
            color: #dcdcaa; 
            text-align: right; /* Alinear números a la derecha se ve mejor */
            display: flex;
            flex-direction: column;
            justify-content: center;
            line-height: 1.1;
        }
        .stack-addr { color: #569cd6; }
        .highlight { background-color: #264f78; color: white; display: block; }
        .btn-ctrl { width: 120px; }
        h4 { color: #dcdcaa; margin-top: 10px; }

        /* Estilo para la caja de la pila */
        .stack-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
        }

        .stack-row {
            display: flex;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 5px;
            align-items: center;
            transition: background 0.3s;
        }

        /* Fila especial si es la dirección apuntada por RSP o RBP */
        .row-rsp { border-left: 4px solid #4ec9b0; background-color: #253330; }
        .row-rbp { border-left: 4px solid #ce9178; }

        .cell-offset { 
            width: 70px; 
            color: #4fc1ff; 
            font-weight: bold; 
            text-align: right;
            margin-right: 10px;
            border-right: 1px solid #555;
            padding-right: 10px;
        }

        .cell-val { 
            flex-grow: 1; 
            color: #dcdcaa; 
            text-align: center;
            /* Esto permite tener varias líneas en la celda (Decimal arriba, Hex abajo) */
            display: flex;       
            flex-direction: column; 
            justify-content: center;
            line-height: 1.1; 
        }

        .cell-addr {
            font-size: 0.75rem;
            color: #666;
            margin-left: 10px;
        }

        /* Etiquetas (tags) para RSP/RBP */
        .tag {
            font-size: 0.7rem;
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            color: #000;
            font-weight: bold;
        }
        .tag-rsp { background-color: #4ec9b0; }
        .tag-rbp { background-color: #ce9178; }
    </style>
</head>
<body class="container-fluid py-3">
    <h2 class="text-center mb-4" style="color:#4ec9b0">Compilador & Visualizador x86</h2>
    
    <div class="row">
        <div class="col-md-4">
            <h4>1. Código C</h4>
            <textarea id="c_code" spellcheck="false">
#include <stdio.h>

int main() {
    int a = 10;
    int b = 20;
    int suma = a + b;
    
    printf("La suma es: %d\n", suma);
    
    return 0;
}</textarea>
            <button class="btn btn-success w-100 mt-2" onclick="compilar()">COMPILAR Y DEPURAR</button>
            
            <h4 class="mt-3">4. Salida (Stdout)</h4>
            <div id="console" class="box" style="height: 100px; color: #0f0;"></div>
        </div>

        <div class="col-md-4">
            <h4>2. Ensamblador Generado</h4>
            <textarea id="asm_code" readonly></textarea>
        </div>

        <div class="col-md-4">
            <h4>3. Estado de la CPU</h4>
            
            <div class="d-flex justify-content-between mb-2">
                <button class="btn btn-primary btn-sm btn-ctrl" onclick="prevStep()">&#8592; Anterior</button>
                <span id="step-lbl" class="align-self-center">Paso: 0 / 0</span>
                <button class="btn btn-primary btn-sm btn-ctrl" onclick="nextStep()">Siguiente &#8594;</button>
            </div>

            <div class="row">
                <div class="col-6">
                    <h5 style="color: #4fc1ff">Registros</h5>
                    <div id="regs-box" class="box">Esperando...</div>
                </div>
                <div class="col-6">
                    <h5 style="color: #c586c0">Pila (Stack)</h5>
                    <div id="stack-box" class="box">Esperando...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let debugData = [];
        let currentStep = 0;

        async function compilar() {
            const code = document.getElementById('c_code').value;
            const asmBox = document.getElementById('asm_code');
            const cons = document.getElementById('console');
            
            cons.innerText = "Procesando...";
            
            try {
                const response = await fetch('/compile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code: code})
                });
                const data = await response.json();

                if (data.error) {
                    cons.innerText = data.error;
                    cons.style.color = 'red';
                } else {
                    cons.style.color = '#0f0';
                    asmBox.value = data.asm;
                    cons.innerText = data.output;
                    
                    // Cargar datos de depuración
                    debugData = data.debug_steps || [];
                    currentStep = 0;
                    updateVisuals();
                }
            } catch (e) {
                cons.innerText = "Error de red: " + e;
            }
        }

        function updateVisuals() {
            const stepLabel = document.getElementById('step-lbl');
            const regsBox = document.getElementById('regs-box');
            const stackBox = document.getElementById('stack-box');

            if (debugData.length === 0) {
                stepLabel.innerText = "Sin datos";
                regsBox.innerHTML = "<div class='text-muted p-2'>Ejecuta el código para ver el estado.</div>";
                stackBox.innerHTML = "";
                return;
            }

            stepLabel.innerText = `Paso: ${currentStep + 1} / ${debugData.length}`;
            const step = debugData[currentStep];

            // --- 1. RENDERIZAR REGISTROS (Mejorado: Decimal + Hex) ---
            let regsHtml = "<table class='table table-dark table-sm table-borderless mb-0'>";
            
            let rbpVal = BigInt(step.regs['rbp'] || 0);
            let rspVal = BigInt(step.regs['rsp'] || 0);

            for (const [key, val] of Object.entries(step.regs)) {
                // 1. Convertir Hex a BigInt
                let valBig = BigInt(val);
                
                // 2. Interpretar como entero con signo de 64 bits
                // (Esto convierte 0xFF...FFFB en -5 correctamente)
                let valSigned = BigInt.asIntN(64, valBig);

                // 3. Formato Decimal
                let decimalStr = valSigned.toString();

                regsHtml += `<tr>
                    <td style="color:#569cd6; width:50px; vertical-align:middle; font-weight:bold;">${key}</td>
                    <td class='reg-val'>
                        <span style="color:#ce9178; font-size:1.1em; font-weight:bold;">${decimalStr}</span>
                        <div style="color:#6a9955; font-size:0.75em;">${val}</div>
                    </td>
                </tr>`;
            }
            regsHtml += "</table>";
            regsBox.innerHTML = regsHtml;

            // --- 2. RENDERIZAR PILA (Visualización Inteligente) ---
            let stackHtml = "<div class='stack-container'>";

            // Iteramos sobre los datos del stack que nos dio GDB
            step.stack.forEach(item => {
                let addrInt = BigInt(item.addr);
                let valInt = parseInt(item.val, 16); // Valor numérico para mostrar en decimal
                
                // Calcular Offset: (Dirección - RBP)
                let offset = addrInt - rbpVal;
                let offsetStr = "";
                let rowClass = "stack-row";
                let tags = "";

                // Determinar etiquetas y offsets amigables
                if (addrInt === rspVal) {
                    rowClass += " row-rsp";
                    tags += "<span class='tag tag-rsp'>RSP</span>";
                }
                if (addrInt === rbpVal) {
                    rowClass += " row-rbp";
                    tags += "<span class='tag tag-rbp'>RBP</span>";
                    offsetStr = "0"; // RBP apunta aquí
                } else {
                    // Convertir offset a string (ej: -4, -8)
                    offsetStr = offset.toString();
                }

                // Si el offset es positivo, ponerle un +
                if (offset > 0) offsetStr = "+" + offsetStr;

                // Interpretación del valor (Hex + Decimal si es pequeño)
                // --- CÓDIGO NUEVO ---
                // 1. Convertir Hex a Entero con Signo de 32 bits
                // En JS, parseInt es positivo. El operador bitwise '>> 0' fuerza la conversión a 32-bit con signo.
                let signedInt = valInt >> 0;

                // 2. Intentar interpretar como Float (Opcional, muy útil para tus ejercicios anteriores)
                let buffer = new ArrayBuffer(4);
                let view = new DataView(buffer);
                view.setInt32(0, signedInt);
                let floatVal = view.getFloat32(0);
                // Redondeamos para visualización limpia
                let floatStr = floatVal.toFixed(4); 

                // 3. Construir la visualización: 
                // Prioridad: Decimal ( Entero )
                let displayVal = `<span style='color:#dcdcaa; font-weight:bold; font-size:1.1em'>${signedInt}</span>`;

                // Agregamos el Hex en pequeño y gris
                displayVal += ` <div style='color:#569cd6; font-size:0.75em'>${item.val}</div>`;

                // (Opcional) Si parece un float válido (no cero, no nan, no infinito), lo mostramos como hint
                if (floatVal !== 0 && !isNaN(floatVal) && Math.abs(floatVal) < 1000000 && Math.abs(floatVal) > 0.0001) {
                    displayVal += ` <div style='color:#ce9178; font-size:0.75em'>Float: ${floatStr}</div>`;
                }

                stackHtml += `
                <div class='${rowClass}'>
                    <div class='cell-offset'>rbp${offsetStr}</div>
                    <div class='cell-val'>${displayVal}</div>
                    <div class='cell-addr'>${item.addr}</div>
                    ${tags}
                </div>`;
            });

            stackHtml += "</div>";
            stackBox.innerHTML = stackHtml;
        }

        function nextStep() {
            if (currentStep < debugData.length - 1) {
                currentStep++;
                updateVisuals();
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                updateVisuals();
            }
        }
    </script>
</body>
</html>